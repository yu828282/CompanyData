<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Agency</title>
    <link rel="stylesheet" href="/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/main.css">
    <script src="/bootstrap.min.js"></script>
    <%         
        const pageSize = 10; 
        const startIdx = (parseInt(currentPage) - 1)* pageSize;
        const totalPages = Math.ceil(parseInt(totalCount) / pageSize);
        const startPage = Math.max(1, parseInt(currentPage) - 2);
        const endPage = Math.min(totalPages, parseInt(currentPage) + 2);
    %>
    <script>        
        function handleRowClick(event, id) {
            const target = event.target;
            if (target.tagName.toLowerCase() !== 'a') {
                window.location.href = `/detail/${id}`;
            }
        }
        
    </script>
</head>
<body>
    <%-include('header.ejs') %>
    <div class="container my-5">
        <div class="search d-flex justify-content-end" >
            <form action="/profile/1" method="get">
                <div class="input-group">     
                    <input type="text" class="form-control" name="searchWord" value="<%= searchWord %>" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button id="button-addon2" class="btn btn-outline-secondary" type="submit">ê²€ìƒ‰</button>  
                </div>
            </form>     
        </div>
        <caption>
            ì„ê¸°ë§Œë£Œ ì˜ˆì • : <span class="alertRed"><%- countTermEnd %></span>ê°œ
            / ì´ <%- totalCount %>ê°œ íšŒì‚¬  
            <a href="#" id="termHeader">ì„ê¸° í†µí•©ì •ë ¬</a>
            <a href="#" id="twoMonthTerm">âœ‰ï¸ 2ë‹¬</a>
            <a href="#" id="oneMonthTerm">ğŸ—¨ï¸ 1ë‹¬</a>
            <a href="#" id="twoWeekTerm">ğŸ“ 2ì£¼</a>
        </caption>
        <div class="table-responsive main-table main-table">
            <table id="profileTable" class="table table-hover table-bordered">
                <thead>
                    <tr class="table-secondary">
                        <th>No</th>
                        <th>ìƒí˜¸</th>
                        <th>ì„¤ë¦½ì¼</th>
                        <th>ì·¨ì„ì¼</th>
                        <th>ë‹´ë‹¹ì</th>
                        <th>ì—°ë½ì²˜</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ê°ì‚¬</th>
                        <th>ê²°ì‚°</th>
                        <th><a href="#" id="directorTermHeader">ì´ì‚¬ì„ê¸°</a></th>
                        <th><a href="#" id="auditorTermHeader">ê°ì‚¬ì„ê¸°</a></th>
                        <th>ë¹„ê³ </th>
                        <th>ìˆ˜ì •</th>
                        <th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody>
                    <% for (let i = startIdx; i < Math.min(startIdx + pageSize, lists.length); i++) { 
                        let x = i % pageSize;
                    %>
                        <tr class="clickable" onclick="handleRowClick(event, '<%=lists[i].id%>')">
                            <td data-label="No"> <%=lists[i].id%> </td>
                            <td data-label="ìƒí˜¸"> <a href="/detail/<%=lists[i].id%>"><%=lists[i].corp%></a> </td>
                            <td data-label="ì„¤ë¦½ì¼"> <%=formatDate(lists[i].date)%> </td>
                            <td data-label="ì·¨ì„ì¼"> <%=formatDate(lists[i].eDate)%> </td>
                            <td data-label="ë‹´ë‹¹ì"> <%=lists[i].manager%> </td>
                            <td data-label="ì—°ë½ì²˜"> <%=lists[i].phone%> </td>
                            <td data-label="ì´ë©”ì¼"> <%-lists[i].email%> </td>        
                            <td data-label="ê°ì‚¬"> <%= lists[i].auditor === 1 ? 'â—‹' : ' ' %> </td>
                            <td data-label="ê²°ì‚°"> <%=lists[i].closing%> </td>
                            <td data-label="ì´ì‚¬ì„ê¸°" class= "<%= isDatePastTwoMonth(formatDate(lists[i].directorTerm)) ? 'alertRed' : ''  %> "><%=formatDate(lists[i].directorTerm)%> </td>
                            <td data-label="ê°ì‚¬ì„ê¸°" class= "<%= isDatePastTwoMonth(formatDate(lists[i].auditorTerm)) ? 'alertRed' : ''  %> "><%=formatDate(lists[i].auditorTerm)%> </td>
                            <td data-label="ë¹„ê³ "> <%=lists[i].memo%> </td>       
                            <td data-label="ìˆ˜ì •"> <a onclick=toggleDiv(<%=x%>)>ìˆ˜ì •</a></td>
                            <td data-label="ì‚­ì œ"> <a href="/profileDelete?id=<%=lists[i].id%>" onclick="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')">ì‚­ì œ</a></td>       
                        </tr>
                        <tr class="updateForm" style="display: none;">
                            <form action="/updateForm?id=<%=lists[i].id%>" method="post">
                                <td> <%= lists[i].id %> </td>
                                <td><input class="form-control update-input" type="text" name="corp" value="<%= lists[i].corp %>" required></td>
                                <td><input class="form-control" type="date" name="date" value="<%= formatDate(lists[i].date) %>"></td>
                                <td><input class="form-control updateEdate" type="date" name="eDate" value="<%= formatDate(lists[i].eDate) %>" onchange="updateInput(<%=x%>)" required></td>
                                <td><input class="form-control" type="text" name="manager" value="<%= lists[i].manager %>" required></td>
                                <td><input class="form-control" type="text" name="phone" value="<%= lists[i].phone %>" oninput="oninputPhone(this)" required></td>
                                <td><input class="form-control" type="text" name="email" value="<%= lists[i].email %>" required></td>
                                <td><input class="form-check-input updateAuditor" type="checkbox" name="auditor" onchange="updateInput(<%=x%>)"  value="1" <%= lists[i].auditor === 1 ? "checked" : "" %> />ê°ì‚¬ìˆìŒ</td>
                                <td class="closing">
                                    <input class="form-check-input updateClosingSix" type="radio" name="closing" onchange="updateInput(<%=x%>)" value="6" <%= lists[i].closing === 6 ? "checked" : "" %> required />6
                                    <input class="form-check-input updateClosingTwelve" type="radio" name="closing" onchange="updateInput(<%=x%>)" value="12" <%= lists[i].closing === 12 ? "checked" : "" %> required />12
                                </td>
                                <td><input class="updateDirectorTerm" type="date" name="directorTerm" value="<%= formatDate(lists[i].directorTerm) %>" required /></td>
                                <td><input class="updateAuditorTerm"  type="date" name="auditorTerm" value="<%= formatDate(lists[i].auditorTerm) %>" /></td>
                                <td><textarea name="memo" class="form-control"><%= lists[i].memo %></textarea></td>
                                <td colspan="2"><button type="submit" class="btn btn-outline-secondary">ìˆ˜ì •</button></td>
                            </form>
                        </tr>  
                    <% } %>
                </tbody>
            </table>
        </div>
        <nav class="d-flex justify-content-center">
            <ul class="pagination">
                    <li class="page-item <%= currentPage > 1 ? '' : 'disabled' %> "><a class="page-link" href="/profile/1?term=<%= term %>&searchWord=<%= searchWord %>">ì²˜ìŒ</a></li>
                    <li class="page-item <%= currentPage > 1 ? '' : 'disabled' %> "><a class="page-link" href="/profile/<%= currentPage - 1 %>?term=<%= term %>&searchWord=<%= searchWord %>">&laquo;</a></li>
                <% for (let i = startPage; i <= endPage; i++) { %>
                    <li class="page-item <%= i === parseInt(currentPage) ? 'actives' : '' %>""><a class="page-link" href="/profile/<%= i %>?term=<%= term %>&searchWord=<%= searchWord %>"><%= i %></a></li>
                <% } %>
                    <li class="page-item <%= currentPage < totalPages ? '' : 'disabled' %>"><a class="page-link" href="/profile/<%= parseInt(currentPage) + 1 %>?term=<%= term %>&searchWord=<%= searchWord %>">&raquo;</a></li>
                    <li class="page-item <%= currentPage < totalPages ? '' : 'disabled' %>"><a class="page-link" href="/profile/<%= totalPages %>?term=<%= term %>&searchWord=<%= searchWord %>">ë</a></li>
            </ul>
        </nav>
        <div class="text-end">
             06ì›” ê²°ì‚°ë²•ì¸ì˜ ê°ì‚¬ì„ê¸° : 7ì›”~ 9ì›”
        </div>
        <div class="text-end">
             12ì›” ê²°ì‚°ë²•ì¸ì˜ ê°ì‚¬ì„ê¸° : 1ì›”~ 3ì›”
        </div>
        <div class="text-end">
             ì„ê¸°ë§Œë£Œ 2ë‹¬ ì „ë¶€í„° &nbsp;<span class="alertRed">ë¶‰ì€ìƒ‰</span>ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
        </div>
    </div>
    <%-include('footer.ejs') %>
    <script>        

        function oninputPhone(target) {
            target.value = target.value
                .replace(/[^0-9]/g, '')
                .replace(/(^02.{0}|^01.{1}|[0-9]{3,4})([0-9]{3,4})([0-9]{4})/g, "$1-$2-$3");
        }
        function toggleDiv(num) {
        const div = document.getElementsByClassName('updateForm')[num];
        if (window.innerWidth < 767) {        // ëª¨ë°”ì¼ ë˜ëŠ” íƒœë¸”ë¦¿ì—ì„œëŠ” blockìœ¼ë¡œ í† ê¸€
            div.style.display = (div.style.display === "block") ? "none" : "block";
        } else {        // PC í™”ë©´ì—ì„œëŠ” table-rowë¡œ í† ê¸€
            div.style.display = (div.style.display === "table-row") ? "none" : "table-row";
        }
        }
        function updateInput(num){
            var eDateInput = document.querySelectorAll('.updateEdate')[num];
            var auditorCheckbox = document.querySelectorAll('.updateAuditor')[num];
            var updateClosingSix = document.querySelectorAll('.updateClosingSix')[num];
            var updateClosingTwelve = document.querySelectorAll('.updateClosingTwelve')[num];
            var updateDirectorTerm = document.querySelectorAll('.updateDirectorTerm')[num];
            var updateAuditorTerm = document.querySelectorAll('.updateAuditorTerm')[num];  

            var eDate = new Date(eDateInput.value);            
            eDate.setFullYear(eDate.getFullYear() + 3); // ì´ì‚¬ì„ê¸°ëŠ” ì„¤ë¦½ í›„ 3ë…„ í›„ë¡œ ì„¤ì •
            updateDirectorTerm.valueAsDate = eDate;

            if(!auditorCheckbox.checked){
                var auditorTermDate = new Date(9999, 11, 32); // ê°ì‚¬ ì„ê¸°ëŠ” 9999ë…„ìœ¼ë¡œ ì„¤ì •
                updateAuditorTerm.valueAsDate = auditorTermDate;
            }

            if (updateClosingSix.checked && auditorCheckbox.checked) {
                    var eDate = new Date(eDateInput.value);
                    if (eDate.getMonth() >= 0 && eDate.getMonth() <= 5) {       //1~6ì›” ì‚¬ì´ ì„¤ë¦½ì´ë©´ 
                        var auditorTermDate = new Date(eDate.getFullYear() + 2, 8, 31); // 2ë…„ í›„ì˜ 9ì›” 30ì¼ì´ ê°ì‚¬ ì„ê¸°
                        // ê°ì‚¬ì„ê¸° ì…ë ¥ í•„ë“œì— ì„¤ì •
                        updateAuditorTerm.valueAsDate = auditorTermDate;
                    }
                    if (eDate.getMonth() >= 7 && eDate.getMonth() <= 12) {       //7~12ì›” ì‚¬ì´ ì„¤ë¦½ì´ë©´ 
                        var auditorTermDate = new Date(eDate.getFullYear() + 3, 8, 31); // 3ë…„ í›„ì˜ 9ì›” 30ì¼ì´ ê°ì‚¬ ì„ê¸°
                        // ê°ì‚¬ì„ê¸° ì…ë ¥ í•„ë“œì— ì„¤ì •
                        updateAuditorTerm.valueAsDate = auditorTermDate;
                    }
                }
            if (updateClosingTwelve.checked && auditorCheckbox.checked) {
                var eDate = new Date(eDateInput.value);
                var auditorTermDate = new Date(eDate.getFullYear() + 3, 2, 32); // 3ë…„ í›„ì˜ 3ì›” 31ì¼ì´ ê°ì‚¬ ì„ê¸°
                updateAuditorTerm.valueAsDate = auditorTermDate;
            }            
         }
         
         document.getElementById('termHeader').addEventListener('click', (event) => {
            event.preventDefault();
            const term = 'term'; // ì…ë ¥ëœ ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
            const queryParams = new URLSearchParams(window.location.search);
            queryParams.set('term', term);
            window.location.search = queryParams.toString();
        });
         
         document.getElementById('directorTermHeader').addEventListener('click', (event) => {
            event.preventDefault();
            const term = 'director'; 
            const queryParams = new URLSearchParams(window.location.search);
            queryParams.set('term', term);
            window.location.search = queryParams.toString();
        });
         
         document.getElementById('auditorTermHeader').addEventListener('click', (event) => {
            event.preventDefault();
            const term = 'auditor'; 
            const queryParams = new URLSearchParams(window.location.search);
            queryParams.set('term', term);
            window.location.search = queryParams.toString();
        });
         
         document.getElementById('twoMonthTerm').addEventListener('click', (event) => {
            event.preventDefault();
            const term = 'twoMonth'; 
            const queryParams = new URLSearchParams(window.location.search);
            queryParams.set('term', term);
            window.location.search = queryParams.toString();
        });
         
         document.getElementById('oneMonthTerm').addEventListener('click', (event) => {
            event.preventDefault();
            const term = 'oneMonth';
            const queryParams = new URLSearchParams(window.location.search);
            queryParams.set('term', term);
            window.location.search = queryParams.toString();
        });
         
         document.getElementById('twoWeekTerm').addEventListener('click', (event) => {
            event.preventDefault();
            const term = 'twoWeek'; 
            const queryParams = new URLSearchParams(window.location.search);
            queryParams.set('term', term);
            window.location.search = queryParams.toString();
        });
    </script>
</body>
</html>