<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Agency</title>
    <link rel="stylesheet" href="/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/main.css">
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js" integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4" crossorigin="anonymous"></script>
</head>
<body>
  <script>    
    Kakao.init('2008a212248e102d2bfe8b0a90121f85'); 
    Kakao.isInitialized();
  </script>
    <%         
    const pageSize = 10; 
    const startIdx = (parseInt(currentPage) - 1)* pageSize;
    const totalPages = Math.ceil(parseInt(totalCount[0].totalCount) / pageSize);
    const startPage = Math.max(1, parseInt(currentPage) - 2);
    const endPage = Math.min(totalPages, parseInt(currentPage) + 2);

    function dateTime(dateString) {
      const date = new Date(dateString);
      const hours = String(date.getHours()).padStart(2, '0'); // ì‹œê°„ì€ ë‘ ìë¦¬ë¡œ í¬ë§·
      const minutes = String(date.getMinutes()).padStart(2, '0'); // ë¶„ì€ ë‘ ìë¦¬ë¡œ í¬ë§·
      return `${hours}:${minutes}`;
    }

    %>  
    <%-include('header.ejs') %>
    <div class="main-page px-5">
        <table class="detailTable">
            <thead>
              <tr>
                <td colspan="4" class="fs-3 fw-bold">
                  <%= list[0].corp%>                     
                  <a id="kakaotalk-sharing-btn" href="javascript:;">
                    <img src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_medium.png" class="kakao_icon" alt="ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ë³´ë‚´ê¸° ë²„íŠ¼" />
                  </a>
                  <a class="sendMail" href="javascript:void(0)" onclick="sendMailWithComment();">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">
                      <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z"/>
                    </svg>
                  </a>
                </td>
              </tr> 
            </thead>
            <tbody>
              <tr>
                <th scope="row">id</th>
                <td><%= list[0].id%></td>
                <th scope="row">íšŒì‚¬ëª…</th>
                <td><%= list[0].corp%></td>
              </tr>
              <tr>
                <th scope="row">ì„¤ë¦½ì¼</th>
                <td><%= formatDate(list[0].date)%></td>
                <th scope="row">ì·¨ì„ì¼</th>
                <td><%= formatDate(list[0].eDate)%></td>
              </tr>
              <tr>
                <th scope="row">ë‹´ë‹¹ì</th>
                <td><%= list[0].manager%></td>
                <th scope="row">ì—°ë½ì²˜</th>
                <td><%= list[0].phone%></td>
              </tr>
              <tr>
                <th scope="row">ì´ë©”ì¼</th>
                <td><%= list[0].email%></td>
              </tr>
              <tr>
                <th scope="row">ê°ì‚¬</th>
                <td><%= list[0].auditor == '1' ? 'ìˆìŒ': 'ì—†ìŒ'%></td>
                <th scope="row">ê²°ì‚°</th>
                <td><%= list[0].closing%>ì›”</td>
              </tr>
              <tr>
                <th scope="row">ì´ì‚¬ì„ê¸°</th>
                <td class= "<%= isDatePastTwoMonth(formatDate(list[0].directorTerm)) ? 'alertRed' : ''  %> ">
                  <%= formatDate(list[0].directorTerm)%>
                  <%= isDatePastTwoWeek(list[0].directorTerm) ? '(20ì¼ë„ ì•ˆ ë‚¨ì•˜ì–´ìš”ğŸ˜¢)' : isDatePastOneMonth(list[0].directorTerm) ? '(í•œë‹¬ ë‚´ ë§Œë£Œ)' : isDatePastTwoMonth(list[0].directorTerm) ? '(ë‘ë‹¬ ë‚´ ë§Œë£Œ)' :'' %>
                </td>
                <th scope="row">ê°ì‚¬ì„ê¸°</th>
                <td class= "<%= isDatePastTwoMonth(formatDate(list[0].auditorTerm)) ? 'alertRed' : ''  %> ">
                  <%= formatDate(list[0].auditorTerm)%>
                  <%= isDatePastTwoWeek(list[0].auditorTerm) ? '(20ì¼ë„ ì•ˆ ë‚¨ì•˜ì–´ìš”ğŸ˜¢)' : isDatePastOneMonth(list[0].auditorTerm) ? '(í•œë‹¬ ë‚´ ë§Œë£Œ)' : isDatePastTwoMonth(list[0].auditorTerm) ? '(ë‘ë‹¬ ë‚´ ë§Œë£Œ)' :'' %>
                </td>
              </tr>
              <tr>
                <th scope="row">ë¹„ê³ </th> 
                <td><%= list[0].memo ? list[0].memo.replaceAll(" ", "&nbsp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll("\n", "<br>") : ''%></td>
              </tr>
            </tbody>
          </table>
          <div class="my-3"><strong>ìƒë‹´ì‘ì„±</strong>
            <div class="pb-2 mb-1 small lh-sm border-bottom"></div>
            <form id="commentForm" action="/makeComment?id=<%= list[0].id%>" method="post" class="row gy-2 gx-3 align-items-center">
              <div class="col-auto bottom input-small"> ìƒë‹´ë°©ë²• : <input id="contactMethod" type="text" name="contact" class="form-control" required></div>
              <div class="col-auto">ìƒë‹´ë‚ ì§œ : <input id="contactDate" type="date" name="date" class="form-control" required></div>
              <div class="col-auto">ìƒë‹´ì‹œê°„ : <input id="contactTime" type="time" name="time" class="form-control"></div>
              <div class="col-auto"> ìƒë‹´ì§ì› : <input id="contactUser" type="text" name="user" class="form-control" placeholder="ìƒë‹´í•œ ì§ì› ì´ë¦„" value="<%= locals.userName%>" required></div>
              <div class="col-auto"> ì œëª© : <input id="contactTitle" type="text" name="title" class="form-control" placeholder="ê°„ëµí•œ ë‚´ìš©" required></div>                    
              <div class="col-auto">ë©”ëª¨ : <br><textarea id="contactMemo" name="memo" class="form-control" cols="30" rows="1" placeholder="ì„¸ë¶€ ë‚´ìš©"></textarea></div>
              <div class="col-auto bottom"><button class="btn btn-outline-secondary">ì œì¶œ</button></div>
            </form>
          </div>
          <strong>ìƒë‹´ê¸°ë¡</strong>
          <div class="pb-2 mb-1 small lh-sm border-bottom"></div>

          <% for (let i = startIdx; i < Math.min(startIdx + pageSize, commentLists.length); i++) { 
            let x = i % pageSize;
            %>
            <div class="row gy-2 gx-3 align-items-center d-flex align-items-center">
              <div class="col-auto input-small"><input type="text" name="contact" class="form-control" value="<%-commentLists[i].contact%>" required></div>
              <div class="col-auto"><input type="date" name="date" class="form-control" value="<%-formatDate(commentLists[i].date)%>" readonly></div>
              <div class="col-auto"><input type="time" name="time" class="form-control" value="<%-dateTime(commentLists[i].date)%>" readonly></div>
              <div class="col-auto input-small"><input type="text" name="user" class="form-control" placeholder="ìƒë‹´í•œ ì§ì› ì´ë¦„" value="<%-commentLists[i].user%>" readonly></div>
              <div class="col-auto"><input type="text" name="title" class="form-control" placeholder="ê°„ëµí•œ ë‚´ìš©" value="<%-commentLists[i].title%>"  readonly></div>                    
              <div class="col-90"><textarea name="memo" class="form-control" cols="30" rows="1" placeholder="ì„¸ë¶€ ë‚´ìš©" readonly><%-commentLists[i].memo%></textarea></div>
              <div class="col-auto bottom"><a onclick=toggleDiv(<%=x%>)>ìˆ˜ì •</a></div>
              <div class="col-auto bottom"><a href='/commentDelete?id=<%= commentLists[i].commentId %>&corpid=<%=id%>' onclick="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')">ì‚­ì œ</a></div>
            </div>
            <div class="updateForm" style="display: none;">
              <form action="/updateComment?id=<%= commentLists[i].commentId%>&corpid=<%=id%>" method="post" class="row gy-2 gx-3 align-items-center">
                  <div class="col-auto bottom input-small"> ìƒë‹´ë°©ë²• :
                      <input type="text" name="contact" class="form-control" value="<%-commentLists[i].contact%>" required>
                  </div>
                  <div class="col-auto">ìƒë‹´ë‚ ì§œ : <input type="date" name="date" class="form-control" value="<%-formatDate(commentLists[i].date)%>" required></div>
                  <div class="col-auto">ìƒë‹´ì‹œê°„ : <input type="time" name="time" class="form-control" value="<%-dateTime(commentLists[i].date)%>"></div>
                  <div class="col-auto input-small"> ìƒë‹´ì§ì› : <input type="text" name="user" class="form-control" placeholder="ìƒë‹´í•œ ì§ì› ì´ë¦„" value="<%-commentLists[i].user%>" required></div>
                  <div class="col-auto"> ì œëª© : <input type="text" name="title" class="form-control" placeholder="ê°„ëµí•œ ë‚´ìš©" value="<%-commentLists[i].title%>" required></div>                    
                  <div class="col-auto">ë©”ëª¨ : <br><textarea name="memo" class="form-control" cols="30" rows="1" placeholder="ì„¸ë¶€ ë‚´ìš©"><%-commentLists[i].memo%></textarea></div>
                  <div class="col-auto bottom"><button class="btn btn-outline-secondary">ì œì¶œ</button></div>
              </form>
              <div class="mb-3"></div>
            </div>
            <% }
              %>              
        <nav class="d-flex justify-content-center p-3">
          <ul class="pagination">
                  <li class="page-item <%= currentPage > 1 ? '' : 'disabled' %> "><a class="page-link" href="/detail/<%-id%>?currentPage=1">ì²˜ìŒ</a></li>
                  <li class="page-item <%= currentPage > 1 ? '' : 'disabled' %> "><a class="page-link" href="/detail/<%-id%>?currentPage=<%- (parseInt(currentPage) - 1) %>">&laquo;</a></li>
              <% for (let i = startPage; i <= endPage; i++) { %>
                  <li class="page-item <%= i === parseInt(currentPage) ? 'actives' : '' %>""><a class="page-link" href="/detail/<%-id%>?currentPage=<%= i %>"><%= i %></a></li>
              <% } %>
                  <li class="page-item <%= currentPage < totalPages ? '' : 'disabled' %>"><a class="page-link" href="/detail/<%-id%>?currentPage=<%- (parseInt(currentPage) + 1) %>">&raquo;</a></li>
                  <li class="page-item <%= currentPage < totalPages ? '' : 'disabled' %>"><a class="page-link" href="/detail/<%-id%>?currentPage=<%- parseInt(totalPages) %>">ë</a></li>
          </ul>
      </nav>
      <div class="d-flex justify-content-end px-1">
        <button class="btn btn-outline-secondary" onclick = "history.back();">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
    <%-include('footer.ejs') %>
    <script>       
       function toggleDiv(num) {            
            const div = document.getElementsByClassName('updateForm')[num];
            div.style.display === "none" ? div.style.display = "table-row" : div.style.display = "none";
        }
        
        let auditorTerm = '';
        if(`<%= list[0].auditor %>` == '1'){
          auditorTerm = 'ê°ì‚¬ì„ê¸° ë§Œë£Œì¼ : <%= formatDate(list[0].auditorTerm)%>';
        }

      Kakao.Share.createDefaultButton({
        container: '#kakaotalk-sharing-btn',
        objectType: 'text',
        text:
          `ì•ˆë…•í•˜ì„¸ìš”, í•´í”¼ë¸Œë¦¿ì§€ ì…ë‹ˆë‹¤. \n ë²•ì¸(ìƒí˜¸ : <%= list[0].corp%>)ì˜ ì„ê¸°ë§Œë£Œì¼ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤. 
          \n\nì´ì‚¬ì„ê¸° ë§Œë£Œì¼ : <%= formatDate(list[0].directorTerm)%> \n ${auditorTerm} 
          \n\në²•ì¸ ë³€ê²½ë“±ê¸°ì— ëŒ€í•œ ìì„¸í•œ ì‚¬í•­ì€ í•˜ë‹¨ ë§í¬ ì°¸ê³  ë¶€íƒë“œë¦½ë‹ˆë‹¤. \n`,
        link: {
          // [ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜] > [í”Œë«í¼] ì—ì„œ ë“±ë¡í•œ ì‚¬ì´íŠ¸ ë„ë©”ì¸ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
          mobileWebUrl: 'http://localhost:3000/',
          webUrl: 'http://localhost:3000/',
        },
      });
      async function submitCommentForm(contactMethod) {
        const form = document.getElementById('commentForm');
        form.querySelector('input[name="contact"]').value = `ì´ë©”ì¼`;
        form.querySelector('input[name="date"]').value = String(new Date().getFullYear()) +'-'+ String(new Date().getMonth() + 1).padStart(2, '0') +'-'+String(new Date().getDate()).padStart(2, '0'); // monthëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1 í•„ìš”
        form.querySelector('input[name="time"]').value = String(new Date().getHours()).padStart(2, '0') +':'+ String(new Date().getMinutes()).padStart(2, '0') + ':00'; 
        form.querySelector('input[name="user"]').value = "<%= locals.userName%>"; // ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
        form.querySelector('input[name="title"]').value = `ì•ˆë‚´ë¬¸ ë°œì†¡`; // ì œëª© ì„¤ì •
        form.querySelector('textarea[name="memo"]').value = `${contactMethod}ìœ¼ë¡œ ìƒë‹´ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.`; // ë©”ëª¨ ì„¤ì •
        await new Promise((resolve) => {
            form.submit();
            resolve();
        });
      }

      async function sendMailWithComment() {
          const checkSendMail = confirm('ì´ë©”ì¼ì„ ë³´ë‚¼ê¹Œìš”?');
          if (!checkSendMail) return; // confirmì—ì„œ ì·¨ì†Œë¥¼ ëˆŒë €ì„ ê²½ìš° í•¨ìˆ˜ ì¢…ë£Œ
          await submitCommentForm('ì´ë©”ì¼');
          window.location.href = '/sendmail/<%= list[0].id %>';
      }

      document.getElementById('kakaotalk-sharing-btn').addEventListener('click', function() {
        const form = document.getElementById('commentForm');
        form.querySelector('input[name="contact"]').value = `ì¹´ì¹´ì˜¤í†¡`;
        form.querySelector('input[name="date"]').value = String(new Date().getFullYear()) +'-'+ String(new Date().getMonth() + 1).padStart(2, '0') +'-'+String(new Date().getDate()).padStart(2, '0'); // monthëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1 í•„ìš”
        form.querySelector('input[name="time"]').value = String(new Date().getHours()).padStart(2, '0') +':'+ String(new Date().getMinutes()).padStart(2, '0') + ':00'; 
        form.querySelector('input[name="user"]').value = "<%= locals.userName%>"; // ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
        form.querySelector('input[name="title"]').value = `ì•ˆë‚´ë¬¸ ë°œì†¡`; // ì œëª© ì„¤ì •
        form.querySelector('textarea[name="memo"]').value = `ì¹´ì¹´ì˜¤í†¡ ì•ˆë‚´ë¬¸ ë°œì†¡.`; // ë©”ëª¨ ì„¤ì •
      });
    </script>
</body>
</html>